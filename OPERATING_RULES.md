# 運用ルール（Codex/Gemini 共通）

本プロジェクトにおけるエージェント運用の恒久ルールを明記します。CODEX を基本とし、問題発生時は GEMINI をフォールバック候補として扱います。

## 基本方針
- 変更前説明: ファイル編集・変更の前に、目的・意図を日本語で1–2文で説明し、必要に応じて承認を得る。
- 最小変更: 無関係な差分を避け、関連箇所のみを最小限で変更する。
- 秘匿情報: APIキーやトークンを生成・保存・出力しない。リポジトリに含めない。
- API抑止: 外部APIを自動で呼ぶ実装や挙動は入れない。APIを消費する処理はユーザーの明示的許可とキー提供がある場合のみ有効化。
- 検証優先: コード変更後はローカルで `pnpm --filter web build` など最小単位で検証。

## ツール選択とフォールバック
- 既定: CODEX を使用。
- 障害時: CODEX が使用不能/無応答の場合は、GEMINI に切替提案を行い、ユーザー承認後にフォールバックする。

## キーと環境変数
- 生成禁止: CODEX/GEMINI いずれも API キーを勝手に生成しない。
- 露出禁止: 実キーをログ・パッチ・画面に表示しない。
- サンプル管理: `.env.example` に空のプレースホルダのみを記載。実運用の `.env.local` はユーザー管理とする。

## 実装上のガード例（方針）
- フラグ駆動: `process.env.FEATURE_ENABLE_EXTERNAL_API !== 'true'` の場合は外部呼び出しを禁止。
- フェイルファスト: 必須環境変数が未設定なら起動時/実行時に安全に失敗（例外）させる。
- 非同期の隔離: 外部通信は1か所に集約し、明示的に enable されるまで noop 実装にしておく。

## 変更手順の型
1) 変更前説明（目的/効果/影響範囲）
2) パッチ適用（関連最小限）
3) ローカル検証（ビルド/型/テスト）
4) 変更点の一覧と次の一手を共有

## ビルド検証フロー（CI 主体）
- 既定: GitHub Actions（`.github/workflows/web-build.yml`）で自動ビルド検証を実施。
  - Node 20 / pnpm を使用し、`pnpm install --frozen-lockfile` → `pnpm --filter web build` を実行。
  - push / PR で自動起動。失敗時は Actions のログを基に修正する。
- マージ基準: CI がグリーンであること（原則 main 直 push を避け、PR で運用）。
- ローカル検証: 任意。必要に応じて以下を用いる。
  - `pnpm dev`（web:3000 / studio:3333）
  - `pnpm --filter web build`（Next.js 単体ビルド）
  - `vercel build`（本番相当の追加確認が必要な場合のみ）

---
本ドキュメントは運用ルールの唯一の正本です。更新時は必ず変更前説明と承認を経てください。
